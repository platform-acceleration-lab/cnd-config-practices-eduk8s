<!doctype html>
<html>
<head>
<meta charset="utf-8">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/3.0.1/github-markdown.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.18.1/lib/index.min.js">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/markdown-it-texmath@0.6.5/css/texmath.css">
<link rel="stylesheet" href="https://gitcdn.xyz/repo/goessner/mdmath/master/css/vscode-texmath.css">

</head>
<body class="markdown-body">
<h1 id="using-configmaps-to-set-environment-variables-1" data-line="0" class="code-line">Using ConfigMaps to set environment variables</h1>
<p data-line="2" class="code-line">To gain an understanding of how to use ConfigMaps in Kubernetes to set
environment variables for your application.</p>
<h1 id="learning-outcomes-2" data-line="5" class="code-line">Learning Outcomes</h1>
<p data-line="7" class="code-line">After completing the lab, you will be able to:</p>
<ul>
<li data-line="9" class="code-line">Explain how to configure an application running on Kubernetes using a ConfigMap</li>
<li data-line="10" class="code-line">Describe how to view Pod logs</li>
</ul>
<h2 id="running-in-a-container-1" data-line="12" class="code-line">Running in a container</h2>
<p data-line="14" class="code-line">Now that you have made changes to your code, you need to build a new
container image.</p>
<ol>
<li data-line="17" class="code-line">
<p data-line="17" class="code-line">Use the <code>bootBuildImage</code> task to build a new image. This time
specify the repository and the version while building the image.</p>
<pre><code data-line="20" class="code-line language-bash"><div>./gradlew bootBuildImage --imageName={{ registry_host }}/pal-tracker:v1
</div></code></pre>
</li>
<li data-line="24" class="code-line">
<p data-line="24" class="code-line">Try running your new image.</p>
<pre><code data-line="26" class="code-line language-bash"><div>docker run --rm -p 8080:8080 <span class="hljs-variable">${YOUR_DOCKER_HUB_USERNAME}</span>/pal-tracker:v1
</div></code></pre>
<p data-line="30" class="code-line">Inspect the exception that is being thrown.</p>
</li>
<li data-line="32" class="code-line">
<p data-line="32" class="code-line">To handle multiple environment variables more easily across Docker
container instances, create a <code>dockerenv</code> file in the root of your
application with the key/value pair contents:</p>
<pre><code data-line="36" class="code-line language-bash"><div>WELCOME_MESSAGE=hello from dockerenv file
</div></code></pre>
</li>
<li data-line="40" class="code-line">
<p data-line="40" class="code-line">Tell <code>docker run</code> to read the environment variables from the file:</p>
<pre><code data-line="42" class="code-line language-bash"><div>docker run --env-file=dockerenv --rm -p 8080:8080 <span class="hljs-variable">${YOUR_DOCKER_HUB_USERNAME}</span>/pal-tracker:v1
</div></code></pre>
</li>
<li data-line="46" class="code-line">
<p data-line="46" class="code-line">Once you are confident your application runs from within the
container, publish the new version to Docker Hub.</p>
<pre><code data-line="49" class="code-line language-bash"><div>docker push <span class="hljs-variable">${YOUR_DOCKER_HUB_USERNAME}</span>/pal-tracker:v1
</div></code></pre>
</li>
<li data-line="53" class="code-line">
<p data-line="53" class="code-line">Delete the <code>dockerenv</code> file, it is no longer needed.</p>
</li>
</ol>
<h2 id="deploy-the-new-image-1" data-line="55" class="code-line">Deploy the new image</h2>
<ol>
<li data-line="57" class="code-line">
<p data-line="57" class="code-line">Update your Deployment yaml file to use the new version of your
image:</p>
<pre><code data-line="60" class="code-line language-diff"><div>      containers:
        - name: pal-tracker-container
<span class="hljs-deletion">-         image: YOUR_DOCKER_HUB_USERNAME/pal-tracker:v0</span>
<span class="hljs-addition">+         image: YOUR_DOCKER_HUB_USERNAME/pal-tracker:v1</span>
</div></code></pre>
</li>
<li data-line="67" class="code-line">
<p data-line="67" class="code-line">Before applying the change to the Deployment run
<code>kubectl get pods --watch</code>.
This will show you a running status of the Pods as changes are
applied.
Run the following commands in a new terminal window so you can
monitor the Pod changes in real time.</p>
</li>
<li data-line="74" class="code-line">
<p data-line="74" class="code-line">To apply your Deployment changes, run the same command you ran when
you first created the Deployment:</p>
<pre><code data-line="77" class="code-line language-bash"><div>kubectl apply -f k8s/deployment.yaml
</div></code></pre>
<p data-line="81" class="code-line">View the output of the <code>kubectl get pods --watch</code>.
You will see a new Pod being created, and the old Pod getting
terminated.
The new Pod will start crashing and you will see it cycle its
STATUS between &quot;Running&quot;, &quot;Error&quot;, and &quot;CrashLoopBackOff&quot;.</p>
</li>
<li data-line="87" class="code-line">
<p data-line="87" class="code-line">View the logs of the Pod by running:</p>
<pre><code data-line="89" class="code-line language-bash"><div>kubectl logs -lapp=pal-tracker --tail=100
</div></code></pre>
<p data-line="93" class="code-line">This will show the last 100 lines of system out and system error
from Pods with the label <code>app: pal-tracker</code>.
Right now you only have a single Pod, but when you scale to multiple
Pods this same command will fetch logs from all of them.</p>
</li>
<li data-line="98" class="code-line">
<p data-line="98" class="code-line">Inspect the exception that is being thrown.</p>
</li>
</ol>
<h2 id="configure-the-app-using-a-configmap-1" data-line="100" class="code-line">Configure the app using a ConfigMap</h2>
<p data-line="102" class="code-line">Your application is failing to start because <code>welcome.message</code> is not
configured.
To set this value, you will create a Kubernetes ConfigMap to hold a set
of key/value pairs.
Then you will update your Deployment to fetch the <code>welcome.message</code>
value out of the ConfigMap, and set it as an environment variable in
the container running your app.</p>
<ol>
<li data-line="110" class="code-line">
<p data-line="110" class="code-line">Create a <code>configmap.yaml</code> file with the following contents:</p>
<pre><code data-line="112" class="code-line language-terminal:execute"><code><div>command: git show configmap-solution:configmap.yaml
session: 2
</div></code></code></pre>
</li>
<li data-line="117" class="code-line">
<p data-line="117" class="code-line">Apply the <code>configmap.yaml</code>:</p>
<pre><code data-line="119" class="code-line language-bash"><div>kubectl apply -f k8s/configmap.yaml
</div></code></pre>
<p data-line="123" class="code-line">You can verify the ConfigMap created successfully by running
<code>kubectl get configmaps</code> and
<code>kubectl describe configmap pal-tracker</code>.</p>
</li>
<li data-line="127" class="code-line">
<p data-line="127" class="code-line">In your Deployment, add an <code>env</code> section to your container</p>
<pre><code data-line="129" class="code-line language-diff"><div>        - name: pal-tracker-container
          image: {{ registry_host }}/pal-tracker:v1
<span class="hljs-addition">+         env:</span>
<span class="hljs-addition">+           - name: WELCOME_MESSAGE</span>
<span class="hljs-addition">+             valueFrom:</span>
<span class="hljs-addition">+               configMapKeyRef:</span>
<span class="hljs-addition">+                 name: pal-tracker</span>
<span class="hljs-addition">+                 key: welcome.message</span>
</div></code></pre>
<p data-line="140" class="code-line">The <code>env</code> section above sets an environment variable named
<code>WELCOME_MESSAGE</code>.
The value for <code>WELCOME_MESSAGE</code> is taken from a ConfigMap object
named <code>pal-tracker</code>.
Within the ConfigMap it looks for a value using the key
<code>welcome.message</code>.</p>
</li>
<li data-line="147" class="code-line">
<p data-line="147" class="code-line">Apply the Deployment manifest.</p>
</li>
<li data-line="149" class="code-line">
<p data-line="149" class="code-line">Your Pod will now start successfully.
Try navigating to the development domain using a web browser.
You will now see the welcome message you set in the ConfigMap.</p>
</li>
<li data-line="153" class="code-line">
<p data-line="153" class="code-line">Commit and push your changes.</p>
</li>
</ol>
<h1 id="assignment-1" data-line="155" class="code-line">Assignment</h1>
<p data-line="157" class="code-line">Submit the assignment using the <code>cloudNativeDeveloperK8sConfigMap</code>
gradle task.
It requires you to provide the URL of your application running on
Kubernetes and the name of your ConfigMap.
For example:</p>
<pre><code data-line="163" class="code-line language-bash"><div><span class="hljs-built_in">cd</span> ~/workspace/assignment-submission
./gradlew cloudNativeDeveloperK8sConfigMap -PserverUrl=http://<span class="hljs-variable">${YOUR_APPLICATION_URL}</span> -PconfigMapName=pal-tracker
</div></code></pre>
<h1 id="learning-outcomes-3" data-line="168" class="code-line">Learning Outcomes</h1>
<p data-line="170" class="code-line">Now that you have completed the lab, you should be able to:
::learningOutcomes::</p>
<h1 id="resources-1" data-line="173" class="code-line">Resources</h1>
<ul>
<li data-line="175" class="code-line"><a href="https://kubernetes.io/docs/tasks/configure-pod-container/configure-pod-configmap/" data-href="https://kubernetes.io/docs/tasks/configure-pod-container/configure-pod-configmap/">ConfigMap Overview</a></li>
<li data-line="176" class="code-line"><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.19/#configmap-v1-core" data-href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.19/#configmap-v1-core">ConfigMap API Documentation</a></li>
</ul>

</body></html>